<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ListaComprasApp.ViewModels"
             xmlns:models="clr-namespace:ListaComprasApp.Models"
             x:Class="ListaComprasApp.Views.ListaDetalhesPage"
             x:DataType="viewmodels:ListaDetalhesViewModel"
             Title="{Binding Title}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header com resumo -->
        <Border Grid.Row="0" 
                Background="{StaticResource Primary}"
                Padding="20">
            <StackLayout>
                <Label Text="{Binding ListaAtual.Nome}"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="White"
                       HorizontalTextAlignment="Center" />
                <Label Text="{Binding ListaAtual.ValorTotalCalculado, StringFormat='Total: R$ {0:F2}'}"
                       FontSize="16"
                       TextColor="White"
                       HorizontalTextAlignment="Center" />
            </StackLayout>
        </Border>

        <!-- FormulÃ¡rio de adicionar item -->
        <Border Grid.Row="1" 
                BackgroundColor="LightBlue"
                Padding="15">
            <StackLayout>
                <Label Text="Adicionar Item"
                       FontSize="16"
                       FontAttributes="Bold" />

                <Entry Placeholder="Nome do produto"
                       Text="{Binding NomeItem}" />

                <Grid ColumnDefinitions="*,*">
                    <Picker Grid.Column="0"
                            Title="Unidade"
                            ItemsSource="{Binding Unidades}"
                            SelectedItem="{Binding UnidadeSelecionada}" />
                    <Picker Grid.Column="1"
                            Title="Categoria"
                            ItemsSource="{Binding Categorias}"
                            SelectedItem="{Binding CategoriaSelecionada}" />
                </Grid>

                <StackLayout Orientation="Horizontal">
                    <CheckBox x:Name="checkValorTotal"
                              IsChecked="{Binding UsarValorTotal}" />
                    <Label Text="Usar valor total (ao invÃ©s de unitÃ¡rio x quantidade)"
                           VerticalOptions="Center">
                        <Label.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCheckBoxTapped" />
                        </Label.GestureRecognizers>
                    </Label>
                </StackLayout>

                <StackLayout IsVisible="{Binding UsarValorTotal}">
                    <Entry Placeholder="Valor total"
                           Keyboard="Numeric"
                           Text="{Binding ValorTotalManual}" />
                </StackLayout>

                <StackLayout IsVisible="{Binding UsarValorTotal, Converter={StaticResource InvertedBoolConverter}}">
                    <Grid ColumnDefinitions="*,*">
                        <Entry Grid.Column="0"
                               Placeholder="Quantidade"
                               Keyboard="Numeric"
                               Text="{Binding Quantidade}" />
                        <Entry Grid.Column="1"
                               Placeholder="Valor unitÃ¡rio"
                               Keyboard="Numeric"
                               Text="{Binding ValorUnitario}" />
                    </Grid>
                </StackLayout>

                <Button Text="Adicionar Item"
                        BackgroundColor="Green"
                        TextColor="White"
                        Command="{Binding AdicionarItemCommand}" />
            </StackLayout>
        </Border>

        <!-- Lista de itens -->
        <CollectionView Grid.Row="2"
                       ItemsSource="{Binding Itens}"
                       BackgroundColor="LightGray">
            <CollectionView.EmptyView>
                <StackLayout VerticalOptions="CenterAndExpand" 
                            HorizontalOptions="CenterAndExpand"
                            Padding="50">
                    <Label Text="Nenhum item adicionado"
                           FontSize="18"
                           HorizontalTextAlignment="Center"
                           TextColor="Gray" />
                </StackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Item">
                    <SwipeView>
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Excluir"
                                          BackgroundColor="Red"
                                          Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ListaDetalhesViewModel}}, Path=ExcluirItemCommand}"
                                          CommandParameter="{Binding .}" />
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Border BackgroundColor="White"
                               Margin="10,5"
                               Padding="15"
                               Opacity="{Binding Comprado, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <CheckBox Grid.Column="0"
                                    IsChecked="{Binding Comprado}">
                                    <CheckBox.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ListaDetalhesViewModel}}, Path=MarcarCompradoCommand}"
                             CommandParameter="{Binding .}" />
                                    </CheckBox.GestureRecognizers>
                                </CheckBox>
                                <StackLayout Grid.Column="1" 
                                            VerticalOptions="Center">
                                    <Label Text="{Binding Nome}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextDecorations="{Binding Comprado, Converter={StaticResource BoolToTextDecorationsConverter}}" />
                                    <StackLayout Orientation="Horizontal">
                                        <Label Text="{Binding Quantidade, StringFormat='{0:F1}'}"
                                               FontSize="12"
                                               TextColor="Gray" />
                                        <Label Text="{Binding UnidadeTexto}"
                                               FontSize="12"
                                               TextColor="Gray" />
                                        <Label Text="â€¢"
                                               FontSize="12"
                                               TextColor="Gray" />
                                        <Label Text="{Binding CategoriaTexto}"
                                               FontSize="12"
                                               TextColor="Blue" />
                                    </StackLayout>
                                </StackLayout>

                                <StackLayout Grid.Column="2" 
                                            VerticalOptions="Center">
                                    <Label Text="{Binding ValorTotal, StringFormat='R$ {0:F2}'}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           HorizontalTextAlignment="End"
                                           TextColor="Green" />
                                    <Label Text="{Binding ValorUnitario, StringFormat='R$ {0:F2}/{1}', ConverterParameter={Binding UnidadeTexto}}"
                                           FontSize="10"
                                           HorizontalTextAlignment="End"
                                           TextColor="Gray"
                                           IsVisible="{Binding ValorTotalManual, Converter={StaticResource IsNullConverter}}" />
                                </StackLayout>
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- BotÃµes de aÃ§Ã£o -->
        <StackLayout Grid.Row="3" Orientation="Horizontal" Margin="20">
            <Button Text="ðŸ›’ Produtos PadrÃ£o"
            FontSize="16"
            FontAttributes="Bold"
            BackgroundColor="Orange"
            TextColor="White"
            Margin="0,0,10,0"
            HeightRequest="50"
            HorizontalOptions="FillAndExpand"
            Command="{Binding AbrirProdutosPadraoCommand}" />

            <Button Text="Finalizar Compra"
            FontSize="18"
            FontAttributes="Bold"
            BackgroundColor="DarkGreen"
            TextColor="White"
            HeightRequest="50"
            HorizontalOptions="FillAndExpand"
            Command="{Binding FinalizarCompraCommand}" />
        </StackLayout>
       
    </Grid>
</ContentPage>